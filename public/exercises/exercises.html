<!-- public/exercises.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exercises page</title>
  <link rel="stylesheet" href="./exstyles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
</head>

<body>
  <header>
    <h1><a href="/" class="home-link">CodeChampions</a></h1>
  </header>
  <!-- Sorting buttons -->
  <div class="sort-container">
    <span>Sort by:</span>
    <div class="custom-dropdown">
      <div class="selected-option" onclick="toggleDropdown()">Difficulty</div>
      <ul id="dropdown-options">
        <li value="difficulty" onclick="selectOption(this)">Difficulty</li>
        <li value="category" onclick="selectOption(this)">Category</li>
      </ul>
    </div>
  </div>

  <!-- Table for displaying exercises -->
  <table>
    <thead>
      <tr>
        <th>Status</th>
        <th>Problem</th>
        <th>Category</th>
        <th>Difficulty</th>
      </tr>
    </thead>
    <tbody id="exerciseList"></tbody>
  </table>

  <!-- Notification and Log In button -->
  <div id="notification-container" style="display: none;">
  
    <div class="session-expired-notification">
      <div class="logo">
        <img class='image' src="https://cdn-icons-png.flaticon.com/512/610/610021.png">
        <h3>CodeChampions</h3>
      </div>
      <div>
      <p>Your session is over!</p>
      <p style="font-size: 0.7em;color: rgb(163, 163, 163)"> Please sign in or if you don't have account, sign up</p>
        <p class="button" onclick="redirectToLoginPage()">SIGN IN</p>
        <p class="or">———— OR ————</p>
        <p class="button" onclick="redirectToMainPage()">SIGN UP</p>
      </div>
    </div>
    
    <button id="login-button" style="display: none;" onclick="redirectToLoginPage()">Log in</button>
</div>

  <script>

    function redirectToLoginPage() {
        window.location.href = '/login';
    }

    function redirectToMainPage() {
    window.location.href = '/register';
    }


    function toggleDropdown() {
      const dropdownOptions = document.getElementById('dropdown-options');
      dropdownOptions.classList.toggle('show');
    }

    function selectOption(option) {
      const selectedOption = document.querySelector('.selected-option');
      selectedOption.textContent = option.textContent;
      toggleDropdown(); // Скрыть выпадающий список после выбора опции
      sortBy(option.getAttribute('value')); // Добавлен вызов sortBy
    }

    document.addEventListener('DOMContentLoaded', function () {
      // When the page is loaded, fetch exercises from the server
      fetch('/api/exercises')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch exercises');
          }
          return response.json();
        })
        .then(exercises => {
          // Display the fetched exercises in the table
          const exerciseList = document.getElementById('exerciseList');
          exercises.forEach(exercise => {
            const row = document.createElement('tr');
            const difficultyClass = `difficulty-${exercise.difficulty.toLowerCase()}`;
            const categoryClass = `category-${exercise.category.toLowerCase()}`;
            const statusIcon = 'fas fa-spinner';
            row.innerHTML = `
              <td> <i class="${statusIcon}"></i></td>
              <td class="exercise-name"><a href="/exercises/${exercise.exercise_id}">${exercise.name}</a></td>
              <td class="${categoryClass}">${exercise.category}</td>
              <td class="${difficultyClass}">${exercise.difficulty}</td>
            `;
            exerciseList.appendChild(row);
          });
        })
        .catch(error => {
          console.error(error);
          // Handle error (e.g., show an error message to the user)
        });
    });

    function sortBy(key) {
      if (key == "") {
        return;
      }
      const exerciseList = document.getElementById('exerciseList');
      while (exerciseList.firstChild) {
        exerciseList.firstChild.remove();
      }

      // Make a fetch request to the server with the selected key as a parameter
      fetch(`/api/exercises/sort?key=${key}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to sort exercises by ${key}`);
          }
          return response.json();
        })
        .then(exercises => {
          // Add the sorted exercises to the table
          exercises.forEach(exercise => {
            const row = document.createElement('tr');
            const difficultyClass = `difficulty-${exercise.difficulty.toLowerCase()}`;
            const categoryClass = `category-${exercise.category.toLowerCase()}`;
            const statusIcon = 'fas fa-spinner';
            row.innerHTML = `
              <td> <i class="${statusIcon}"></i></td>
              <td><a href="/exercises/${exercise.exercise_id}">${exercise.name}</a></td>
              <td class="${categoryClass}">${exercise.category}</td>
              <td class="${difficultyClass}">${exercise.difficulty}</td>
            `;
            exerciseList.appendChild(row);
          });
        })
        .catch(error => {
          console.error(error);
          // Handle error (e.g., show an error message to the user)
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
      const sessionTimeout = 30000; // 5 minutes in milliseconds
      let sessionTimer;

      // Функция, которая отправляет запрос на сервер для обновления сессии
      function refreshSession() {
        fetch('/api/refresh-session') // Предполагаемый эндпоинт для обновления сессии
          .then(response => {
            if (!response.ok) {
              throw new Error('Failed to refresh session');
            }
            return response.json();
          })
          .then(data => {
            console.log('Session refreshed:', data);
            resetSessionTimer();
          })
          .catch(error => {
            console.error('Error refreshing session:', error);
            // Обработка ошибки (например, показать сообщение пользователю)
          });
      }

      // Функция, которая показывает уведомление о завершении сессии
      function showSessionExpiredNotification() {
        // Скрываем таблицу с заданиями
        const exerciseTable = document.querySelector('table');
        if (exerciseTable) {
          exerciseTable.style.display = 'none';
        }

        const notificationContainer = document.getElementById('notification-container');
        if (notificationContainer) {
          notificationContainer.style.display = 'block';
        }
      }

      // Функция для закрытия уведомления
      window.closeNotificationBanner = function () {
        // Показываем таблицу с заданиями
        const exerciseTable = document.querySelector('table');
        if (exerciseTable) {
          exerciseTable.style.display = 'table';
        }

        const notificationContainer = document.getElementById('notification-container');
        if (notificationContainer) {
          notificationContainer.style.display = 'none';
        }
      };

      function redirectToLoginPage() {
        window.location.href = '/login';
      }

      function resetSessionTimer() {
        clearTimeout(sessionTimer);

        // Запустить таймер заново
        sessionTimer = setTimeout(() => {
          showSessionExpiredNotification();
        }, sessionTimeout);
      }

      // Запускаем таймер при загрузке страницы
      resetSessionTimer();

      // Запускать функцию обновления сессии каждые 4 минуты
      const refreshInterval = setInterval(refreshSession, 240000); // 4 minutes in milliseconds

      document.addEventListener('mousemove', resetSessionTimer);
      document.addEventListener('keydown', resetSessionTimer);

      // Остановить таймер обновления сессии при закрытии страницы
      window.addEventListener('beforeunload', function () {
        clearInterval(refreshInterval);
      });
    });
  </script>
</body>

</html>
