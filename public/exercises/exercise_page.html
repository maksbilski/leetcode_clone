<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title id="page-title"></title>

	<!-- Adding CodeMirror stylesheet -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.css">

	<link rel="stylesheet" href="./styles.css">

	<!-- Adding main script of CodeMirror -->
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.js"></script>

	<!-- Adding script for Python mode -->
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/mode/python/python.js"></script>

	<!-- Adding main script of Brython -->
	<script src="https://cdn.jsdelivr.net/npm/brython@3.9.5/brython.min.js"></script>

</head>

<body>
	<header>
		<h1><a href="/" class="home-link">CodeChampions</a></h1>
	</header>
	<div class="content-container">
		<div class="problem-description">
			<h2 id="problem-title"></h2>
			<p id="problem-description"></p>
		</div>
		<div class="code-editor-and-buttons">
			<div class="code-editor">
				<textarea id="editor" placeholder="Enter your code here..."></textarea>
			</div>
			<div class="console-and-buttons">
				<div class="console" id="console">
					<span id="console-label">You must run the code first.</span>
				</div>
				<div class="buttons">
					<button id="console-btn">Console</button>
					<div class="run-submit-container">
						<button id="run-btn">Run</button>
						<button id="submit-btn">Submit</button>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script>
		document.addEventListener('DOMContentLoaded', function () {
			var editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
				lineNumbers: true,
				mode: "python",
				smartIndent: true,
				indentUnit: 4,
				tabSize: 4,
				indentWithTabs: true,
				styleActiveLine: true
			});

			const pathArray = window.location.pathname.split('/');
			const exerciseId = pathArray[pathArray.length - 1];

			const savedCode = localStorage.getItem('savedCode-' + exerciseId);
			if (savedCode) {
				editor.setValue(savedCode);
			}

			fetch(`/api/exercises/${exerciseId}`)
				.then(response => {
					if (!response.ok) {
						throw new Error('Failed to fetch exercise page');
					}
					return response.json();
				})
				.then(exercise => {
					document.getElementById('page-title').innerText = exercise.name
					document.getElementById('problem-title').innerText = exercise.name;
					document.getElementById('problem-description').innerText = exercise.content;
				})
				.catch(error => {
					console.error(error);
				});
			document.getElementById('run-btn').addEventListener('click', function () {
				const code = editor.getValue();
				localStorage.setItem('savedCode-' + exerciseId, code);

				const data = {
					exerciseId: exerciseId,
					code: code
				};

				fetch(`/api/exercises/${exerciseId}/run_code`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(data)
				})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response not ok');
						}
						return response.json();
					})
					.then(data => {
						const output = [
							'stdout:',
							data.output || 'No stdout output.',
							'--------------------------',
							'stderr:',
							data.errorOutput || 'No stderr output.'
						].join('\n');
						document.getElementById('console-label').textContent = output;
					})
					.catch(error => {
						console.error('Could not save the code:', error);
					});
			});
			document.getElementById('console-btn').addEventListener('click', function () {
				const consoleElement = document.getElementById('console');
				consoleElement.style.display = consoleElement.style.display === 'none' ? 'block' : 'none';
			})
		});
	</script>

</body>

</html>