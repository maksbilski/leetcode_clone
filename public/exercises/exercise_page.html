<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title id="page-title"></title>

	<!-- Adding CodeMirror stylesheet -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.min.css">

	<link rel="stylesheet" href="./styles.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">

	<!-- Adding main script of CodeMirror -->
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/lib/codemirror.js"></script>

	<!-- Adding script for Python mode -->
	<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.0/mode/python/python.js"></script>

</head>

<body>
	<header>
		<div class="logo">
			<img class='image' src="https://cdn-icons-png.flaticon.com/512/610/610021.png">
			<h1 id="home">CodeChampions</h1>
		</div>

		<div class="nav-buttons">
			<div>
				<p id="exercises">Exercises</p>
			</div>
			<div>
				<p id="statistics">Statistics</p>
			</div>
			<div>
				<p id="profile">Profile</p>
			</div>
			<div>
				<p id="help">Help</p>
			</div>
		</div>
		<div class="login-register">
			<div>
				<p id="login">Sign in</p>
			</div>
			<div>
				<p id="register">Sign up</p>
			</div>
		</div>
	</header>
	<div class="content-container">
		<div class="problem-description-and-comments">
			<div class="problem-description">
				<div class="problem-header">
					<h2 id="problem-title" style="font-size: 2.3em; font-weight: bold;"></h2>
					<div class="likes-dislikes-info">
						<div id="like-button">
							<span id="likes-count"></span>
							<i class="fa fa-thumbs-up"></i>
						</div>
						<div id="dislike-button">
							<span id="dislikes-count"></span>
							<i class="fa fa-thumbs-down"></i>
						</div>
					</div>

				</div>
				<p id="problem-description"></p>
				<div class="discussion-header" tabindex="0" aria-expanded="false" role="button">
					Discussion
					<span class="arrow">&#9660;</span>
				</div>
			</div>
			<div class="discussion-container" id="discussion-container">
				<div class="add-comment">
					<textarea id="comment-text" rows="4" placeholder="Type comment here..."></textarea>
					<button id="add-comment-btn">Comment</button>
				</div>
				<div class="existing-comments">
					<ul id="comment-list">

					</ul>
				</div>
			</div>
		</div>
		<div class="code-editor-and-buttons">
			<div class="code-editor">
				<textarea id="editor" placeholder="Enter your code here..."></textarea>
			</div>
			<div class="console-and-buttons">
				<div class="console" id="console">
					<pre id="console-label">You must run the code first.</pre>
				</div>
				<div class="buttons-container">
					<button id="console-btn">Console</button>
					<div class="run-submit-container">
						<button id="run-btn">Run</button>
						<button id="submit-btn">Submit</button>
					</div>
				</div>
			</div>
		</div>

	</div>

	<script>
		document.getElementById('exercises').addEventListener('click', function () {
			console.log('dsa')
			window.location.href = '/exercises';
		});

		document.getElementById('statistics').addEventListener('click', function () {
			window.location.href = '/statistics';
		});

		document.getElementById('register').addEventListener('click', function () {
			window.location.href = '/register';
		});

		document.getElementById('home').addEventListener('click', function () {
			window.location.href = '/';
		});

		document.getElementById('login').addEventListener('click', function () {
			window.location.href = '/login';
		});

		document.getElementById('help').addEventListener('click', function () {
			window.location.href = '/help';
		});

		document.getElementById('profile').addEventListener('click', function () {
			window.location.href = '/profile';
		});

		document.addEventListener('DOMContentLoaded', function () {
			var editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
				lineNumbers: true,
				mode: "python",
				smartIndent: true,
				indentUnit: 4,
				tabSize: 4,
				indentWithTabs: true,
				styleActiveLine: true
			});

			document.getElementById('console').style.display = 'none';
			document.getElementById('discussion-container').style.display = 'none';

			const pathArray = window.location.pathname.split('/');
			const exerciseId = pathArray[pathArray.length - 1];

			const savedCode = localStorage.getItem('savedCode-' + exerciseId);
			if (savedCode) {
				editor.setValue(savedCode);
			}

			fetch(`/api/exercises/${exerciseId}`)
				.then(response => response.json())
				.then(exercise => {
					document.getElementById('page-title').innerText = exercise.name;
					document.getElementById('problem-title').innerText = exercise.name;
					document.getElementById('problem-description').innerHTML = exercise.content;
					if (!editor.getValue()) {
						editor.setValue(exercise.solution_draft)
					}
					return fetch(`/api/exercises/${exerciseId}/get_like`);
				})
				.then(response => response.json())
				.then(data => {
					updateLikesDislikes(data.likes, data.dislikes);
				})
				.catch(error => console.error('Error:', error));

			function updateLikesDislikes(likes, dislikes) {
				const totalVotes = likes + dislikes;

				document.getElementById('likes-count').innerText = likes;
				document.getElementById('dislikes-count').innerText = dislikes;
			}


			document.getElementById('like-button').addEventListener('click', function () {
				sendVote(exerciseId, 1);
			});

			document.getElementById('dislike-button').addEventListener('click', function () {
				sendVote(exerciseId, -1);
			});

			function sendVote(exerciseId, voteType) {
				fetch(`/api/exercises/${exerciseId}/post_like`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({ vote: voteType }),
				})
					.then(response => response.json())
					.then(data => {
						updateLikesDislikes(data.likes, data.dislikes);
					})
					.catch(error => console.error('Error:', error));
			}
			fetch(`/api/exercises/${exerciseId}/comments`)
				.then(response => {
					if (!response.ok) {
						throw new Error('Failed to load comments')
					}
					return response.json();
				})
				.then(comments => {
					insertComments(comments);
				})
				.catch(error => {
					console.error('Error fetching comments:', error);
				});
			document.querySelector('.discussion-header').addEventListener('click', function () {
				var expanded = this.getAttribute('aria-expanded') === 'true';
				this.setAttribute('aria-expanded', !expanded);
				const discussionContainer = document.getElementById('discussion-container');
				discussionContainer.style.display = discussionContainer.style.display === 'none' ? 'block' : 'none';
			})
			document.getElementById('add-comment-btn').addEventListener('click', function () {
				const commentContent = document.getElementById('comment-text').value;

				const data = {
					commentContent: commentContent
				};

				fetch(`/api/exercises/${exerciseId}/add_comment`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(data)
				})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network comment response not ok')
						}
						return response.json();
					})
					.then(comments => {
						insertComments(comments);
					})
					.catch(error => {
						console.error('Error fetching comments:', error);
					});

			})
			document.getElementById('run-btn').addEventListener('click', function () {
				const code = editor.getValue();
				localStorage.setItem('savedCode-' + exerciseId, code);

				const data = {
					exerciseId: exerciseId,
					code: code
				};

				fetch(`/api/exercises/${exerciseId}/run_code`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(data)
				})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response not ok');
						}
						return response.json();
					})
					.then(data => {
						const output = data.output;
						document.getElementById('console-label').textContent = output;
						document.getElementById('console').style.display = 'block';
					})
					.catch(error => {
						console.error('Could not save the code:', error);
					});
			})
			document.getElementById('submit-btn').addEventListener('click', function () {
				const code = editor.getValue();
				localStorage.setItem('savedCode-' + exerciseId, code);

				const data = {
					exerciseId: exerciseId,
					code: code
				};

				fetch(`/api/exercises/${exerciseId}/submit_code`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(data)
				})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response not ok');
						}
						return response.json();
					})
					.then(data => {
						let output = data.output;
						document.getElementById('console-label').textContent = output;
						if (data.isSuccessfulSubmition) {
							let roundedPercentage = Math.round(data.percentageOfWorseSolutions);
							document.getElementById('console-label').textContent = output
							+ `Your passed all the tests!\nYou solution was better than ${roundedPercentage}% of other people's submissions`;
						}
						document.getElementById('console').style.display = 'block';
					})
					.catch(error => {
						console.error('Could not save the code:', error);
					});
			})
			document.getElementById('console-btn').addEventListener('click', function () {
				const consoleElement = document.getElementById('console');
				consoleElement.style.display = consoleElement.style.display === 'none' ? 'block' : 'none';
			})
		});

		function insertComments(comments) {
			const listElement = document.getElementById('comment-list');
			listElement.innerHTML = '';

			comments.forEach(comment => {
				const listItem = document.createElement('li');
				listItem.classList.add('comment-item');
				listItem.innerHTML = `
							<div class="comment-content">${comment.comment_content}</div>
							<div class="comment-user">${comment.name}</div>
							<div class="comment-date">${new Date(comment.comment_date).toLocaleString()}</div>
						`;
				listElement.appendChild(listItem);
			})
		};
	</script>

</body>

</html>