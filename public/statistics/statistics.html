<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Statistics Page</title>
  <link rel="stylesheet" type="text/css" href="styles.css">
</head>

<body>
  <header>
    <div class="logo">
      <img class='image' src="https://cdn-icons-png.flaticon.com/512/610/610021.png">
      <h1 id="home">CodeChampions</h1>
    </div>
    
    <div class="nav-buttons">
      <div><p id="exercises">Exercises</p></div>
      <div> <p id="statistics">Statistics</p></div>
      <div><p id="profile">Profile</p></div>
      <div><p id="help">Help</p></div>
  </div>
    <div class="login-register">
      <div><p id="login">Sign in</p></div>
      <div><p id="register">Sign up</p></div>
    </div>
  </header>
  <div class="sort-container">
    <span>Sort by:</span>
    <div class="custom-dropdown">
      <div class="selected-option" onclick="toggleDropdown()">Success rate</div>
      <ul id="dropdown-options">
        <li value="success_rate" onclick="selectOption(this)">Success rate</li>
        <li value="total_exercises_completed" onclick="selectOption(this)">Amount</li>
        <li value="average_percentile" onclick="selectOption(this)">Times</li> <!-- Nowa opcja dodana -->
      </ul>
    </div>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>User</th>
        <th>Exercises Attempted</th>
        <th>Exercises Completed</th>
        <th>Success rate</th>
        <th>Times percentile</th>
      </tr>
    </thead>
    <tbody id="statisticsTable"></tbody>
  </table>
  <script>
    document.getElementById('exercises').addEventListener('click', function() {
    console.log('dsa')
    window.location.href = '/exercises';
  });
  
  document.getElementById('statistics').addEventListener('click', function() {
    window.location.href = '/statistics';
  });
  
  document.getElementById('register').addEventListener('click', function() {
    window.location.href = '/register';
  });

  document.getElementById('login').addEventListener('click', function() {
    window.location.href = '/login';
  });

  document.getElementById('help').addEventListener('click', function() {
    window.location.href = '/help';
  });

  document.getElementById('home').addEventListener('click', function() {
    window.location.href = '/';
  });

  document.getElementById('profile').addEventListener('click', function() {
    window.location.href = '/profile';
  });

    function toggleDropdown() {
      const dropdownOptions = document.getElementById('dropdown-options');
      dropdownOptions.classList.toggle('show');
    }

    function selectOption(option) {
      const selectedOption = document.querySelector('.selected-option');
      selectedOption.textContent = option.textContent;
      toggleDropdown(); // Скрыть выпадающий список после выбора опции
      sortBy(option.getAttribute('value')); // Добавлен вызов sortBy
    }

    document.addEventListener('DOMContentLoaded', function () {
      fetch('/api/statistics')
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to fetch statistics');
          }
          return response.json();
        })
        .then(statistics => {
          const tableBody = document.getElementById('statisticsTable');
          statistics.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
            <td><a href="#" onclick="redirectToProfile(${record.user_id});">${record.name}</a></td>
              <td>${record.total_exercises_attempted}</td>
              <td>${record.total_exercises_completed}</td>
              <td style="color: #3CB371;">${record.success_rate}%</td>
              <td style="color:gray">${record.average_percentile}</td>
            `;
            tableBody.appendChild(row);
          });
        })
        .catch(error => {
          console.error(error);
        });
    });

    function sortBy(key) {
      if (key == "") {
        return;
      }
      const tableBody = document.getElementById('statisticsTable');
      while (tableBody.firstChild) {
        tableBody.firstChild.remove();
      }

      fetch(`/api/statistics/sort?key=${key}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Failed to sort statistics by ${key}`);
          }
          return response.json();
        })
        .then(statistics => {
          statistics.forEach(record => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><a href="#" onclick="redirectToProfile(${record.user_id});">${record.name}</a></td>
              <td>${record.total_exercises_attempted}</td>
              <td>${record.total_exercises_completed}</td>
              <td>${record.success_rate}%</td>
              // <td>${record.average_percentile}</td> 
            `;
            tableBody.appendChild(row);
          });
        })
        .catch(error => {
          console.error(error);
        });
    }
    function redirectToProfile(userId) {
        window.location.href = `/profile/${userId}`;
        }
  </script>
</body>

</html>